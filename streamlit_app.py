import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium

# Streamlit í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ëŒ€í•œë¯¼êµ­ ì§€ì—­ë³„ ê°•ìˆ˜ëŸ‰ ì§€ë„ ë° ë¹„êµ", layout="wide")

st.title("ëŒ€í•œë¯¼êµ­ ì§€ì—­ë³„ ê°•ìˆ˜ëŸ‰ ì§€ë„ ë° ë¹„êµ")
st.markdown("""
ì´ ì›¹ì•±ì€ ëŒ€í•œë¯¼êµ­ì˜ ì§€ì—­ë³„ ê°•ìˆ˜ëŸ‰ ë°ì´í„°ë¥¼ ì§€ë„ ìœ„ì— ì‹œê°í™”í•˜ê³  ë§‰ëŒ€ ì°¨íŠ¸ë¡œ ë¹„êµí•©ë‹ˆë‹¤.
""")

# ìƒ˜í”Œ ê°•ìˆ˜ëŸ‰ ë°ì´í„°
data = {
    "ì§€ì—­": ["ì„œìš¸", "ë¶€ì‚°", "ëŒ€êµ¬", "ì¸ì²œ", "ê´‘ì£¼", "ëŒ€ì „", "ìš¸ì‚°", "ì„¸ì¢…", "ê²½ê¸°", "ê°•ì›", "ì¶©ë¶", "ì¶©ë‚¨", "ì „ë¶", "ì „ë‚¨", "ê²½ë¶", "ê²½ë‚¨", "ì œì£¼"],
    "ê°•ìˆ˜ëŸ‰(mm)": [120, 150, 110, 130, 140, 115, 125, 100, 135, 160, 105, 120, 110, 145, 115, 130, 200],
    "ìœ„ë„": [37.5665, 35.1796, 35.8714, 37.4563, 35.1595, 36.3504, 35.5384, 36.4800, 37.4138, 37.8228, 36.6357, 36.6588, 35.8200, 34.8161, 36.4919, 35.2384, 33.4996],
    "ê²½ë„": [126.9780, 129.0756, 128.6014, 126.7052, 126.8526, 127.3845, 129.3114, 127.2890, 127.5183, 128.1555, 127.4913, 126.6728, 127.1088, 126.4630, 128.8889, 128.6922, 126.5312]
}
df = pd.DataFrame(data)

# --- ì‚¬ì´ë“œë°” í•„í„° ---
st.sidebar.header("ê°•ìˆ˜ëŸ‰ ë²”ìœ„ í•„í„°")

min_val = int(df["ê°•ìˆ˜ëŸ‰(mm)"].min())
max_val = int(df["ê°•ìˆ˜ëŸ‰(mm)"].max())

min_rain, max_rain = st.sidebar.slider(
    "ê°•ìˆ˜ëŸ‰(mm) ë²”ìœ„ ì„ íƒ",
    min_val,
    max_val,
    (min_val, max_val)
)

# í•„í„°ë§ëœ ë°ì´í„°í”„ë ˆì„
filtered_df = df[(df["ê°•ìˆ˜ëŸ‰(mm)"] >= min_rain) & (df["ê°•ìˆ˜ëŸ‰(mm)"] <= max_rain)]

# --- ë°ì´í„° ì‹œê°í™” ì„¹ì…˜ ---
col1, col2 = st.columns(2)

with col1:
    st.subheader("ì§€ì—­ë³„ ê°•ìˆ˜ëŸ‰ ë°ì´í„°")
    st.dataframe(filtered_df, use_container_width=True)

with col2:
    st.subheader("ì§€ì—­ë³„ ê°•ìˆ˜ëŸ‰ ë§‰ëŒ€ ì°¨íŠ¸")
    if not filtered_df.empty:
        chart_data = filtered_df.set_index('ì§€ì—­')['ê°•ìˆ˜ëŸ‰(mm)']
        st.bar_chart(chart_data)
    else:
        st.info("ì„ íƒëœ ê°•ìˆ˜ëŸ‰ ë²”ìœ„ì— í•´ë‹¹í•˜ëŠ” ì§€ì—­ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

st.markdown("---")

# --- ì§€ë„ ìƒì„± ë° ì‹œê°í™” ---
st.subheader("ëŒ€í•œë¯¼êµ­ ì§€ë„ì—ì„œ ê°•ìˆ˜ëŸ‰ ì‹œê°í™”")

# ì§€ë„ ìƒì„±
m = folium.Map(location=[36.5, 127.8], zoom_start=7)

# í•„í„°ë§ëœ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì§€ë„ì— ì›í˜• ë§ˆì»¤ ì¶”ê°€
for idx, row in filtered_df.iterrows():
    radius = max(row["ê°•ìˆ˜ëŸ‰(mm)"] / 15, 5)
    
    folium.CircleMarker(
        location=[row["ìœ„ë„"], row["ê²½ë„"]],
        radius=radius,
        popup=f"**{row['ì§€ì—­']}**: {row['ê°•ìˆ˜ëŸ‰(mm)']}mm",
        color="blue",
        fill=True,
        fill_color="blue",
        fill_opacity=0.6
    ).add_to(m)

st_folium(m, width=900, height=600)

st.markdown("---")

# --- ì§ˆë¬¸ ë° ë‹µë³€ ì„¹ì…˜ (ìƒˆë¡œ ì¶”ê°€ë¨) ---

st.header("ğŸŒ¦ï¸ ê°•ìˆ˜ëŸ‰ ë°ì´í„° ê´€ë ¨ ì§ˆë¬¸ ë° í”¼ë“œë°±")
st.markdown("ì•±ì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì´ë‚˜ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.")

# ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ ì •ì˜
questions = [
    "1. ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì •í–ˆì„ ë•Œ ì§€ë„ ë§ˆì»¤ í¬ê¸°ë„ ë™ì ìœ¼ë¡œ ë³€í•˜ëŠ” ê²ƒì´ ë§Œì¡±ìŠ¤ëŸ¬ìš´ê°€ìš”?",
    "2. í˜„ì¬ ê°•ìˆ˜ëŸ‰ ë°ì´í„°ì˜ ë‹¨ìœ„(mm)ê°€ ëª…í™•í•˜ê²Œ ì´í•´ë˜ë‚˜ìš”?",
    "3. ì°¨íŠ¸ì™€ ì§€ë„ë¥¼ í•¨ê»˜ ë³´ì—¬ì£¼ëŠ” êµ¬ì„±ì´ ê°•ìˆ˜ëŸ‰ ë¹„êµì— íš¨ê³¼ì ì¸ê°€ìš”?",
    "4. ì¶”ê°€í–ˆìœ¼ë©´ í•˜ëŠ” ë°ì´í„°(ì˜ˆ: ì˜¨ë„, ìŠµë„ ë“±)ê°€ ìˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”?",
    "5. ì•± ì‚¬ìš© ì¤‘ ë¶ˆí¸í–ˆë˜ ì ì´ë‚˜ ê°œì„ í•  ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì•Œë ¤ì£¼ì„¸ìš”."
]

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”: ë‹µë³€ì„ ì €ì¥í•˜ê¸° ìœ„í•´ ì‚¬ìš©
if 'answers' not in st.session_state:
    st.session_state.answers = {f'q{i+1}': "" for i in range(len(questions))}

# ë‹µë³€ ì…ë ¥ ë°•ìŠ¤ ìƒì„± í•¨ìˆ˜
def update_answer(question_key):
    # Textareaì˜ í˜„ì¬ ê°’ì„ ì„¸ì…˜ ìƒíƒœì— ì €ì¥
    st.session_state.answers[question_key] = st.session_state[question_key]

# ê° ì§ˆë¬¸ì— ëŒ€í•œ ì…ë ¥ ë°•ìŠ¤ ìƒì„±
with st.container(border=True):
    for i, q in enumerate(questions):
        q_key = f'q{i+1}'
        st.subheader(f"â“ {q}")
        st.text_area(
            "ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”.",
            key=q_key, # ì´ í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì…ë ¥ ê°’ì— ì ‘ê·¼
            value=st.session_state.answers[q_key], # ì„¸ì…˜ ìƒíƒœì— ì €ì¥ëœ ê°’ì„ í‘œì‹œ
            on_change=update_answer, # ê°’ì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì„¸ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
            args=(q_key,), # on_change í•¨ìˆ˜ì— ì „ë‹¬í•  ì¸ì
            placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."
        )
        st.markdown("---")

# (ì„ íƒ ì‚¬í•­) ì €ì¥ëœ ë‹µë³€ì„ í™•ì¸í•˜ëŠ” ë²„íŠ¼ (ë””ë²„ê¹…/í™•ì¸ìš©)
if st.button("ì œì¶œëœ ë‹µë³€ í™•ì¸ (ê°œë°œììš©)"):
    st.json(st.session_state.answers)